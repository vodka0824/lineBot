/**
 * æ‹‰éœ¸ (Slot Machine) åŠŸèƒ½æ¨¡çµ„
 * ç§»æ¤è‡ª mant0u0/LineBot-Mant0u çš„è¦–è¦ºç–ŠåŠ æ–¹æ¡ˆ
 */
const flexUtils = require('../utils/flex');
const { replyFlex } = require('../utils/line');

// ç¬¦è™Ÿæ¸…å–® (å°æ‡‰åœ–ç‰‡ç›®éŒ„ä¸­çš„æª”æ¡ˆåç¨±ï¼š0.png, 1.png, 2.png, 3.png, 4.png, 7.png)
const SYMBOLS = ['0', '1', '2', '3', '4', '7'];
const SYMBOL_NAMES = {
    '0': 'ğŸ° BAR',
    '1': 'ğŸ’§ è—è‰²æœå‡',
    '2': 'ğŸ”” éˆ´éº',
    '3': 'ğŸ‰ è¥¿ç“œ',
    '4': 'ğŸ’ æ«»æ¡ƒ',
    '7': 'Lucky 7'
};

// åœ–ç‰‡è³‡æº Base URL (æ‚¨çš„ GCS Bucket æ ¹ç›®éŒ„)
const IMG_BASE = 'https://storage.googleapis.com/my-linebot-assets';

// ä¸­çç·šè·¯å®šç¾© (8æ¢ç·šçš„ç´¢å¼•)
// 0 1 2
// 3 4 5
// 6 7 8
const WIN_LINES = [
    [0, 1, 2], [3, 4, 5], [6, 7, 8], // æ°´å¹³
    [0, 3, 6], [1, 4, 7], [2, 5, 8], // å‚ç›´
    [0, 4, 8], [2, 4, 6]           // æ–œå°è§’
];

/**
 * åŸ·è¡Œæ‹‰éœ¸
 */
async function handleSlot(replyToken) {
    const layout = [];

    // ç”Ÿæˆ 3x3 éš¨æ©Ÿä½ˆå±€ (0-8 ç´¢å¼•)
    for (let i = 0; i < 9; i++) {
        const randomSym = SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)];
        layout.push(randomSym);
    }

    // æª¢æŸ¥ä¸­ç
    const winners = [];
    WIN_LINES.forEach(line => {
        const [a, b, c] = line;
        if (layout[a] === layout[b] && layout[b] === layout[c]) {
            winners.push({
                line,
                symbol: layout[a]
            });
        }
    });

    // å»ºç«‹ Flex Message
    const flex = buildSlotFlex(layout, winners);
    // å„ªåŒ– altText åŒ…å«ä¸­ççµæœ
    const altText = winners.length > 0
        ? `ğŸ° æ‹‰éœ¸çµæœ - æ­å–œï¼${winners.length} æ¢é€£ç·š`
        : 'ğŸ° æ‹‰éœ¸çµæœ - æœªä¸­ç';
    await replyFlex(replyToken, altText, flex);
}

/**
 * çµ„è£æ‹‰éœ¸ Flex Message (é‚„åŸåŸå§‹è¨­è¨ˆ)
 */
function buildSlotFlex(layout, winners) {
    const { COLORS } = flexUtils;
    const contents = [];

    // 1. åº•åœ–
    contents.push(flexUtils.createImage({
        url: `${IMG_BASE}/bg/1.png`,
        size: 'full',
        aspectRatio: '1:1',
        aspectMode: 'cover'
    }));

    // 2. ç–ŠåŠ  9 å€‹ä½ç½®çš„é€æ˜ç¬¦è™Ÿåœ–å±¤
    const posMapping = ['00', '01', '02', '10', '11', '12', '20', '21', '22'];

    layout.forEach((sym, i) => {
        const posCode = posMapping[i];
        contents.push(flexUtils.createImage({
            url: `${IMG_BASE}/${posCode}/${sym}.png`,
            size: 'full',
            aspectRatio: '1:1',
            aspectMode: 'cover',
            position: 'absolute'
        }));
    });

    // 3. åº•éƒ¨çµæœæ–‡å­—ç›’ï¼ˆå„ªåŒ–ï¼šæ›´æ¸…æ™°çš„å­—é«”èˆ‡èƒŒæ™¯ï¼‰
    let footerText;
    let footerColor = COLORS.DARK_GRAY;

    if (winners.length > 0) {
        const winningSyms = [...new Set(winners.map(w => SYMBOL_NAMES[w.symbol] || w.symbol))];
        footerText = `ğŸŠ æ­å–œï¼é”æˆ ${winners.length} æ¢é€£ç·š (${winningSyms.join(', ')})`;
        footerColor = COLORS.DANGER;
    } else {
        // æœªä¸­çè¨Šæ¯æ± ï¼ˆéš¨æ©Ÿé¸æ“‡ï¼‰
        const loseMessages = [
            // å˜²è«·æŒ‘é‡ç³»åˆ—
            "ä½ çš„é‹æ°£å°±è·Ÿä½ çš„æŠ€è¡“ä¸€æ¨£... ä¸å­˜åœ¨ ğŸ¤£",
            "é€£çºŒå¤±æ•—æ˜¯ä¸€ç¨®å¤©è³¦ï¼Œæ­å–œä½  ğŸ‘",
            "å»ºè­°æ”¹åå«ã€æ²’ä¸­éã€ï¼Œé€™æ¨£æ¯”è¼ƒç¬¦åˆç¾å¯¦ ğŸ˜",
            "é€™é‹æ°£ï¼Œå»è²·æ¨‚é€æ‡‰è©²æœƒè®“åˆ¥äººä¸­å¤§ç ğŸ¯",
            "ä½ æ˜¯ä¸æ˜¯å¾—ç½ªäº†è²¡ç¥çˆºï¼Ÿé‚„æ˜¯å¾—ç½ªäº†æ‰€æœ‰ç¥ï¼ŸğŸ™",
            "æ­å–œï¼åˆä¸€æ¬¡è­‰æ˜äº†å¢¨è²å®šå¾‹ ğŸ“‰",
            "è¦ä¸è¦è€ƒæ…®å»ç•¶å€’æ¥£é¬¼ä»£è¨€äººï¼ŸğŸ¤¡",
            "é€™é‹æ°£æ‹¿å»ç•¶è‚¥æ–™ï¼Œé€£è‰éƒ½é•·ä¸å‡ºä¾† ğŸŒ±",

            // åè«·é¼“å‹µç³»åˆ—
            "åˆ¥ç°å¿ƒï¼Œå¤±æ•—æ˜¯æˆåŠŸä¹‹...ç®—äº†ä½ ä¸æœƒæˆåŠŸçš„ ğŸ’”",
            "å†æ¥å†å²ï¼(åæ­£å†å²ä¹Ÿæ²’ç”¨) ğŸ˜‚",
            "ç›¸ä¿¡è‡ªå·±ï¼ä½ ä¸€å®šæœƒç¹¼çºŒæ§“é¾œçš„ âœ¨",
            "å …æŒå°±æ˜¯å‹åˆ©...çš„åç¾©è© ğŸ³ï¸",
            "ä½ å·²ç¶“è§£é–æˆå°±ï¼šã€æ°¸ä¸æ”¾æ£„çš„è¼¸å®¶ã€‘ğŸ†",

            // å“²å­¸æç¬‘ç³»åˆ—
            "äººç”Ÿå°±åƒæ‹‰éœ¸ï¼Œä½ æ°¸é åœ¨è¼¸ ğŸ°",
            "ä½›æ›°ï¼šè‰²å³æ˜¯ç©ºï¼Œä½ çš„çé‡‘ä¹Ÿæ˜¯ ğŸ™",
            "è–›ä¸æ ¼çš„çé‡‘ï¼šæ‰“é–‹å‰å°±çŸ¥é“æ²’æœ‰ ğŸ“¦",
            "é‡å­åŠ›å­¸è­‰æ˜ï¼šè§€å¯Ÿè€…æœƒå½±éŸ¿çµæœ...ä½†ä½ ä¸è¡Œ ğŸ”¬",

            // å‡å°ˆæ¥­çµ±è¨ˆç³»åˆ—
            "æ ¹æ“šå¤§æ•¸æ“šåˆ†æï¼Œä½ ä¸­çç‡ï¼š0.000...001% ğŸ“Š",
            "AI é æ¸¬ï¼šæ‚¨ä¸‹æ¬¡ä¸­çæ™‚é–“ç‚º2099å¹´ ğŸ¤–",
            "çµ±è¨ˆé¡¯ç¤ºï¼šä½ æ˜¯å…¨ä¼ºæœå™¨æœ€éçš„é‚£å€‹ ğŸ“‰",
            "ç³»çµ±æª¢æ¸¬åˆ°ç•°å¸¸...ä½ çš„é‹æ°£ç•°å¸¸çš„å·® âš ï¸",

            // ç›´ç™½å—†çˆ†ç³»åˆ—
            "å°±...æ²’ä¸­å•Šï¼Œä¸ç„¶å‹’ï¼ŸğŸ˜",
            "çª®é¬¼é å®š ğŸ¦—",
            "æ§“é¾œå°ˆæ¥­æˆ¶ä¸Šç·šäº† ğŸ¯",
            "æ»¾å•¦ï¼ä¸‹ä¸€ä½ ğŸ‘‹",
            "ä½ é‚„æƒ³ä¸­çï¼Ÿé†’é†’å§ â°",

            // å‰µæ„ææ€ªç³»åˆ—
            "å®å’šï½æ‚¨çš„æ­æ°£å·²ä¸‹ç·š ğŸ“´",
            "æ­å–œç²å¾—ï¼šç©ºæ°£ x1 ğŸŒ¬ï¸",
            "ä¸­çåå–®ï¼š[ ä¸æ˜¯ä½  ] âœ–ï¸",
            "ç³»çµ±æç¤ºï¼šæ‚¨çš„å¹¸é‹å€¼å·²é€æ”¯ ğŸ’¸",
            "Achievement Unlocked: éæ´²é…‹é•· ğŸ‘‘",
            "æ‚¨å·²è¢«å¹¸é‹å¥³ç¥æ‹‰é»‘ ğŸš«",

            // æå‹ç³»åˆ—
            "ç¬‘æ­»ï¼Œåˆæ²’ä¸­ ğŸ¤£ğŸ¤£ğŸ¤£",
            "æˆ‘å°±çŸ¥é“ä½ ä¸è¡Œ ğŸ˜",
            "é€™waveç©©è¼¸ï¼Œä¸è™§ ğŸ“‰",
            "å»ºè­°ï¼šæŠŠé‹æ°£è³£äº†æ›éŒ¢ ğŸ’°",
            "ä½ æ˜¯ä¾†æç¬‘çš„å§ï¼Ÿ ğŸ¤¡",

            // é¼“å‹µç¹¼çºŒç³»åˆ—ï¼ˆé™·é˜±ï¼‰
            "å·®ä¸€é»é»å°±ä¸­äº†ï¼(å¤§æ¦‚å·®100é») ğŸ˜…",
            "ä¸‹æ¬¡ä¸€å®šä¸­ï¼(æˆ‘èªªä¸‹è¼©å­) â­ï¸",
            "ç¹¼çºŒè½‰ï¼åæ­£éƒ½åœ¨è¼¸ ğŸ”„",
            "ä¸è¦æ”¾æ£„ï¼é›–ç„¶ä½ æœƒç¹¼çºŒè¼¸ ğŸ’ª",

            // === æ¥µè‡´æ¯’èˆŒæ–°å¢ç³»åˆ— ===
            "ä½ çš„é‹æ°£å¯ä»¥ç”³è«‹é‡‘æ°ä¸–ç•Œç´€éŒ„äº†ï¼ˆæœ€è¡°ï¼‰ ğŸ“–",
            "å»ºè­°æ”¹è¡Œç•¶æƒæŠŠæ˜Ÿï¼Œå°ˆæ¥­å°å£ ğŸŒ ",
            "ä½ åª½çŸ¥é“ä½ é€™éº¼å»¢å—ï¼Ÿ ğŸ‘©",
            "é€£ AI éƒ½ç‚ºä½ çš„é‹æ°£æ„Ÿåˆ°çµ•æœ› ğŸ¤–",
            "éœ‰ç¥ï¼šçµ‚æ–¼æ‰¾åˆ°æ¥ç­äººäº† ğŸ‘»",
            "å»ºè­°æ›´åã€æ°¸ä¸ä¸­çã€æœ‰é™å…¬å¸ CEO ğŸ’¼",
            "ä½ çš„å¹¸é‹å€¼å·²é€²å…¥è² ç„¡çª®å¤§ âˆ",
            "è²¡ç¥çˆºçœ‹åˆ°ä½ éƒ½ç¹è·¯èµ° ğŸƒ",
            "é€™è¼©å­è¨»å®šç•¶å­¤å…’ï¼ˆçé‡‘çš„ï¼‰ ğŸ‘¶",
            "ä½ å°±æ˜¯å‚³èªªä¸­çš„ã€è¡Œèµ°çš„é»‘æ´ã€ ğŸ•³ï¸",
            "å»ºè­°å»è²·æ„å¤–éšªï¼Œå› ç‚ºä½ å°±æ˜¯æ„å¤– ğŸ“‹",
            "ä½ çš„é‹æ°£è­‰æ˜äº†è² èƒ½é‡å®ˆæ†å®šå¾‹ âš¡",
            "æ­å–œï¼ä½ å·²ç¶“çˆ›åˆ°ä¸€å€‹æ–°å¢ƒç•Œ ğŸŠ",
            "é€£ä¹ä¸éƒ½æ¯”ä½ æœ‰éŒ¢ï¼ˆå·®è·ï¼š0å…ƒï¼‰ ğŸª™",
            "ä½ çš„å­˜åœ¨å°±æ˜¯ç‚ºäº†è­‰æ˜ï¼šé‚„èƒ½æ›´æ…˜ ğŸ“‰",
            "å»ºè­°ï¼šå»é ˜æ®˜éšœæ‰‹å†Šï¼ˆé‹æ°£æ®˜éšœï¼‰ â™¿",
            "ä½ æ˜¯å²ä¸Šå”¯ä¸€æŠŠé‹æ°£ç©æˆè² æ•¸çš„äºº â–",
            "è²¡ç¥ï¼šé€™å€‹æˆ‘çœŸçš„æ•™ä¸æœƒ ğŸ‘¨â€ğŸ«",
            "ä½ çš„é‹æ°£å·²ç¶“è¢«å¤©è­´äº† âš¡",
            "å»ºè­°æ”¹åã€è¼¸åˆ°è„«è¤²ã€æ›´è²¼åˆ‡ ğŸ‘–",
            "ä½ å°±æ˜¯ç¾ä»£ç‰ˆçš„ã€è¡°ç¥ã€æœ¬å°Š ğŸ‘¹",
            "é€£åƒåœ¾æ¡¶éƒ½ä¸æƒ³æ”¶ç•™ä½ çš„é‹æ°£ ğŸ—‘ï¸",
            "ä½ çš„å¹¸é‹å€¼å·²ä½æ–¼æµ·å¹³é¢ä»¥ä¸‹9999ç±³ ğŸŒŠ",
            "å»ºè­°ç›´æ¥æŠ•èƒé‡ä¾†ï¼Œé€™è¼©å­æ²’æ•‘äº† â™»ï¸",
            "ä½ æ˜¯ä¾†è­‰æ˜ã€çµ•æœ›ã€é€™å€‹è©çš„å—ï¼Ÿ ğŸ“š",
            "æ­å–œè§£é–éš±è—æˆå°±ï¼šã€å»¢åˆ°æ¥µè‡´ã€‘ ğŸ…",
            "ç³»çµ±æç¤ºï¼šæ‚¨å·²è¢«è¸¢å‡ºå¹¸é‹ç¾¤çµ„ ğŸ‘¥",
            "ä½ çš„åŸºå› è£¡å°±å¯«è‘—ã€loserã€ ğŸ§¬",
            "å»ºè­°å»æ‹œæ‹œï¼Œé †ä¾¿å•å•èƒ½ä¸èƒ½é€€è²¨ï¼ˆæŒ‡ä½ ï¼‰ ğŸ™",
            "è²¡å¯Œèˆ‡ä½ çš„è·é›¢ï¼šå¹³è¡Œå®‡å®™ ğŸŒŒ",
            "ä½ çš„å‘½ç›¤ä¸Šå¯«è‘—ä¸‰å€‹å¤§å­—ï¼šã€æ²’æ•‘äº†ã€ ğŸ“œ",
            "å»ºè­°ï¼šä¹¾è„†å»ç•¶æ‰¶ä¸èµ·çš„é˜¿æ–— ğŸª‘",
            "ä½ çš„é‹æ°£å·²ç¶“ç ´ç”¢å€’é–‰è·‘è·¯äº† ğŸ’¸",
            "éœ‰é‹æ¦œç¬¬ä¸€åï¼šæ­å–œå°±æ˜¯ä½  ğŸ¥‡",
            "å»ºè­°æ”¹è¡Œç•¶ã€æ§“é¾œã€å°ˆæ¥­è¬›å¸« ğŸ“",
            "ä½ çš„å¹¸é‹å·²ç¶“è¢«å®‡å®™å›æ”¶äº† ğŸŒ ",
            "é€£ç‹—éƒ½æ¯”ä½ é‹æ°£å¥½ï¼ˆçœŸçš„ï¼‰ ğŸ•",
            "ä½ æŠŠã€è¡°ã€é€™å€‹å­—ç™¼æ®åˆ°æ¥µè‡´ ğŸ’¯",
            "å»ºè­°ï¼šæŠŠè‡‰å€Ÿçµ¦é›°åœçµ„ç•¶å€’æ¥£é¬¼ ğŸ­",
            "ä½ çš„é‹æ°£å·²ç¶“é€²å…¥å†°æ²³æ™‚æœŸ ğŸ§Š",
            "è²¡ç¥çˆºçš„é»‘åå–®ç¬¬ä¸€ä½å°±æ˜¯ä½  ğŸ“‹",
            "å»ºè­°ç›´æ¥è²·ã€æ°¸ä¸ä¸­çä¿è­‰æ›¸ã€ğŸ’¼",
            "ä½ çš„å­˜åœ¨è­‰æ˜äº†ï¼šçœŸçš„æœ‰äººèƒ½çˆ›æˆé€™æ¨£ ğŸ˜±",
            "æ­å–œï¼ä½ æ˜¯è¡°é‹ä»£è¨€äºº ğŸ¤",
            "å»ºè­°æ”¹åã€å²ä¸Šæœ€å»¢ã€æ¯”è¼ƒèª å¯¦ ğŸ“°",
            "ä½ çš„é‹æ°£å·²ç¶“é€²å…¥æ°¸ä¹…å†¬çœ  ğŸ˜´",
            "é€£é›œé­šéƒ½è¦ºå¾—ä½ å¾ˆé›œé­š ğŸŸ",
            "ä½ å°±æ˜¯ã€é­¯è›‡ã€çš„æœ€çµ‚é€²åŒ–å‹æ…‹ ğŸ›",
            "å»ºè­°ï¼šæŠŠé‹æ°£æçµ¦éœ€è¦çš„äººï¼ˆåè«·ï¼‰ ğŸ",
            "ä½ çš„å¹¸é‹æŒ‡æ•¸ï¼šERROR 404 NOT FOUND ğŸš«",
            "æ­å–œï¼ä½ åˆæˆåŠŸå±•ç¾äº†ä»€éº¼å«ã€å»¢ã€ ğŸ‘",
            "ç³»çµ±åˆ¤å®šï¼šæ‚¨å·²é”æˆã€æ°¸æ†ä¹‹å»¢ã€ç¨±è™Ÿ âš”ï¸",
            "ä½ çš„é‹æ°£å·²ç¶“è¢«é€å»è³‡æºå›æ”¶äº† â™»ï¸",
            "å»ºè­°ç›´æ¥åˆªé™¤è§’è‰²é‡ç·´ ğŸ®",
            "è²¡ç¥ï¼šé€™å­©å­æˆ‘æ˜¯çœŸçš„å¸¶ä¸å‹• ğŸ˜­",
            "ä½ çš„å¹¸é‹å·²é€²å…¥é‡å­ç³¾çºçš„ã€å»¢ã€æ…‹ âš›ï¸",
            "æ­å–œï¼ä½ æ˜¯æœ¬å¹´åº¦æœ€è¡°ä»£è¡¨ ğŸ“…",
            "å»ºè­°ï¼šå»ç«¶é¸ã€å…¨çƒæœ€éé¸æ‹”ã€ä¿è­‰ç•¶é¸ ğŸ—³ï¸"
        ];

        // éš¨æ©Ÿé¸æ“‡ä¸€å€‹è¨Šæ¯
        const randomIndex = Math.floor(Math.random() * loseMessages.length);
        footerText = loseMessages[randomIndex];
    }

    if (winners.length > 0) {
        const winningSyms = [...new Set(winners.map(w => SYMBOL_NAMES[w.symbol] || w.symbol))];
        footerText = `ğŸŠ æ­å–œï¼é”æˆ ${winners.length} æ¢é€£ç·š (${winningSyms.join(', ')})`;
        footerColor = COLORS.DANGER;
    }

    contents.push(flexUtils.createBox('vertical', [
        flexUtils.createText({
            text: footerText,
            align: 'center',
            color: '#FFFFFF',
            weight: 'bold',
            size: 'md',
            wrap: true
        })
    ], {
        position: 'absolute',
        offsetBottom: '55px',  // æ”¹ç‚º 55pxï¼Œåœ¨æŒ‰éˆ•ä¸Šæ–¹
        offsetStart: '0px',
        offsetEnd: '0px',
        backgroundColor: winners.length > 0 ? '#FF0000DD' : '#000000DD',
        paddingAll: '8px'
    }));


    // 4. é‡ç©æŒ‰éˆ•ï¼ˆç½®æ–¼æœ€åº•éƒ¨ï¼‰
    contents.push(flexUtils.createBox('vertical', [
        flexUtils.createButton({
            action: {
                type: 'message',
                label: 'ğŸ° å†ä¾†ä¸€æ¬¡!',
                text: 'ğŸ° æ‹‰éœ¸'
            },
            style: 'primary',
            height: 'sm',
            color: '#FF6B6B'
        })
    ], {
        position: 'absolute',
        offsetBottom: '0px',  // æ”¹ç‚º 0pxï¼Œå®Œå…¨åœ¨æœ€åº•éƒ¨
        offsetStart: '20px',
        offsetEnd: '20px'
    }));

    const bubble = flexUtils.createBubble({
        size: 'mega',
        body: flexUtils.createBox('vertical', contents, { paddingAll: '0px' })
    });

    return bubble;
}

module.exports = {
    handleSlot
};
